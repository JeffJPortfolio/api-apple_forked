<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="admin">
	
	 <!-- 현오 -->
	 	<select id="productSelectList" resultType="com.javaex.vo.jProductVo">
		    <![CDATA[
		    	SELECT
				    p.productNum,
				    p.productName,
				    c.colorNum,
				    c.colorName,
				    c.colorCode,
				    d.displayNum,
				    d.displaySize,
				    s.storageNum,
				    s.storageSize,
				    pd.productDetailNum,
				    pd.productPrice,
				    i.infoImageNum,
				    i.infoImageSavedName,
				    i.infoImagePrimary
				FROM 
				    Product p
				JOIN 
				    ProductDetail pd ON p.productNum = pd.productNum  -- Correct join with ProductDetail
				JOIN 
				    Color c ON pd.colorNum = c.colorNum  -- Color linked to ProductDetail
				JOIN 
				    Display d ON pd.displayNum = d.displayNum  -- Display linked to ProductDetail
				JOIN 
				    Storage s ON pd.storageNum = s.storageNum  -- Storage linked to ProductDetail
				JOIN 
				    InfoImage i ON pd.productNum = i.productNum;  -- InfoImage linked to Product
		    ]]>
		</select>

	 
	 
	<select id="storeSelectList"  resultType="com.javaex.vo.jStoreVo">
	    <![CDATA[
	        select  storeNum, 
	                storeName,
	                storeAddress,
	                storeNumber,
	                storeImage,
	                storeStatus
	        from Store
	        where storeStatus != '폐업'
	    ]]>
	</select>
	
	<update id="storeDelete" parameterType="com.javaex.vo.StoreVo">
	    <![CDATA[
	    UPDATE Store
	    SET
	        storeStatus = '폐업'
	    WHERE
	        storeNum = #{storeNum}
	    ]]>
	</update>
	
	
	
    <!-- Select user for List -->
	<select id="userSelectList" resultType="com.javaex.vo.unionVo">
	    <![CDATA[
	        select  userNum, 
	                userId,
	                userPw,
	                userName,
	                userHp,
	                userAddress
	        from user
	        where userStatus = '회원'  
	    ]]>
	</select>
	
	<update id="userDelete" parameterType="com.javaex.vo.unionVo">
	   <![CDATA[
	    UPDATE User
	    SET
	        userStatus = '탈퇴'
	    WHERE
	        userNum = #{userNum}
	    ]]>
	</update>
	
	<select id="deliverySelectList" resultType="com.javaex.vo.unionVo">
	    <![CDATA[
		SELECT 
		    Receipt.receiptNum,
		    History.historyNum,
		    History.productDetailNum,
		    History.productCount,
		    ProductDetail.seriesNum,
		    ProductDetail.productNum,
		    Product.productName,    -- Added productName from Product table
		    Color.colorName,
		    Display.displaySize,
		    Storage.storageSize,
		    ProductDetail.productPrice,
		    Store.storeName,
		    Store.storeNumber,
		    `User`.userId,
		    `User`.userName,         -- userName from User table
		    `User`.userAddress,      -- userAddress from User table
		    `User`.userHp,           -- userHp from User table
		    Receipt.purchasedDate,
		    Receipt.shippingAddress,
		    Receipt.shippingStatus,
		    Receipt.totalPrice,
		    MAX(productImage.imageSavedName) AS imageSavedName  -- Choose the primary or latest image
		FROM 
		    Receipt
		JOIN 
		    History ON Receipt.receiptNum = History.receiptNum
		JOIN 
		    ProductDetail ON History.productDetailNum = ProductDetail.productDetailNum
		JOIN 
		    Product ON ProductDetail.productNum = Product.productNum
		JOIN 
		    Color ON ProductDetail.colorNum = Color.colorNum 
		    AND ProductDetail.seriesNum = Color.seriesNum
		JOIN 
		    Display ON ProductDetail.displayNum = Display.displayNum 
		    AND ProductDetail.seriesNum = Display.seriesNum
		JOIN 
		    Storage ON ProductDetail.storageNum = Storage.storageNum 
		    AND ProductDetail.seriesNum = Storage.seriesNum
		JOIN 
		    Store ON Receipt.storeNum = Store.storeNum
		JOIN 
		    `User` ON Receipt.userNum = `User`.userNum
		LEFT JOIN 
		    productImage ON ProductDetail.productDetailNum = productImage.productDetailNum  -- Use LEFT JOIN to allow products without images
		WHERE 
		    Receipt.shippingStatus != '배송 완료'
		GROUP BY 
		    Receipt.receiptNum,
		    History.historyNum,
		    History.productDetailNum,
		    ProductDetail.seriesNum,
		    ProductDetail.productNum,
		    Product.productName,
		    Color.colorName,
		    Display.displaySize,
		    Storage.storageSize,
		    ProductDetail.productPrice,
		    Store.storeName,
		    Store.storeNumber,
		    `User`.userId,
		    `User`.userName,
		    `User`.userAddress,
		    `User`.userHp,
		    Receipt.purchasedDate,
		    Receipt.shippingAddress,
		    Receipt.shippingStatus,
		    Receipt.totalPrice

	    ]]>
	</select>

	<update id="productSend" parameterType="com.javaex.vo.unionVo">
	    <![CDATA[
	    UPDATE Receipt
	    SET
	        shippingStatus = '배송 중'
	    WHERE
	        receiptNum = #{receiptNum}
	    ]]>
	</update>
	
	<update id="productArrived" parameterType="com.javaex.vo.unionVo">
	    <![CDATA[
	    UPDATE Receipt
	    SET
	        shippingStatus = '배송 완료'
	    WHERE
	        receiptNum = #{receiptNum}
	    ]]>
	</update>

	
	<select id="historySelectList" parameterType="String" resultType="com.javaex.vo.unionVo">
	    <![CDATA[
	    SELECT 
		    Receipt.receiptNum,
		    History.historyNum,
		    History.productDetailNum,
		    History.productCount,
		    ProductDetail.seriesNum,
		    ProductDetail.productNum,
		    Product.productName,    -- Added productName from Product table
		    Color.colorName,
		    Display.displaySize,
		    Storage.storageSize,
		    ProductDetail.productPrice,
		    Store.storeName,
		    Store.storeNumber,
		    `User`.userId,
		    `User`.userName,         -- userName from User table
		    `User`.userAddress,      -- userAddress from User table
		    `User`.userHp,           -- userHp from User table
		    Receipt.purchasedDate,
		    Receipt.shippingAddress,
		    Receipt.shippingStatus,
		    Receipt.totalPrice,
		    MAX(productImage.imageSavedName) AS imageSavedName  -- Choose the primary or latest image
		FROM 
		    Receipt
		JOIN 
		    History ON Receipt.receiptNum = History.receiptNum
		JOIN 
		    ProductDetail ON History.productDetailNum = ProductDetail.productDetailNum
		JOIN 
		    Product ON ProductDetail.productNum = Product.productNum
		JOIN 
		    Color ON ProductDetail.colorNum = Color.colorNum 
		    AND ProductDetail.seriesNum = Color.seriesNum
		JOIN 
		    Display ON ProductDetail.displayNum = Display.displayNum 
		    AND ProductDetail.seriesNum = Display.seriesNum
		JOIN 
		    Storage ON ProductDetail.storageNum = Storage.storageNum 
		    AND ProductDetail.seriesNum = Storage.seriesNum
		JOIN 
		    Store ON Receipt.storeNum = Store.storeNum
		JOIN 
		    `User` ON Receipt.userNum = `User`.userNum
		LEFT JOIN 
		    productImage ON ProductDetail.productDetailNum = productImage.productDetailNum  -- Use LEFT JOIN to allow products without images
		WHERE 
		    Receipt.shippingStatus = '배송 완료'
		GROUP BY 
		    Receipt.receiptNum,
		    History.historyNum,
		    History.productDetailNum,
		    ProductDetail.seriesNum,
		    ProductDetail.productNum,
		    Product.productName,
		    Color.colorName,
		    Display.displaySize,
		    Storage.storageSize,
		    ProductDetail.productPrice,
		    Store.storeName,
		    Store.storeNumber,
		    `User`.userId,
		    `User`.userName,
		    `User`.userAddress,
		    `User`.userHp,
		    Receipt.purchasedDate,
		    Receipt.shippingAddress,
		    Receipt.shippingStatus,
		    Receipt.totalPrice
	    ]]>
	</select>


	
	
	
	
	<!-- 시리즈 등록 -->
    <insert id="seriesInsert" parameterType="com.javaex.vo.unionVo">
        INSERT INTO Series (seriesName)
        VALUES (#{seriesName})
    </insert>
    
    <!-- 상품 등록 -->
    <insert id="productInsert" parameterType="com.javaex.vo.unionVo">
        INSERT INTO Product (seriesNum, productName, mainImages)
        VALUES (#{seriesNum}, #{productName}, #{mainImages})
    </insert>
	
	<!-- 색상 등록 -->
    <insert id="colorInsert" parameterType="com.javaex.vo.unionVo">
        INSERT INTO Color (productNum, seriesNum, colorName, colorCode)
        VALUES (#{productNum}, #{seriesNum}, #{colorName}, #{colorCode})
    </insert>
    
    <!-- 디스플레이 등록 -->
    <insert id="displayInsert" parameterType="com.javaex.vo.unionVo">
        INSERT INTO Display (productNum, seriesNum, displaySize)
        VALUES (#{productNum}, #{seriesNum}, #{displaySize})
    </insert>
    
    <!-- 용량 등록 -->
    <insert id="storageInsert" parameterType="com.javaex.vo.unionVo">
        INSERT INTO Storage (productNum, seriesNum, storageSize)
        VALUES (#{productNum}, #{seriesNum}, #{storageSize})
    </insert>
    
    <!-- 상품상세 등록 -->
    <insert id="productDetailInsert" parameterType="com.javaex.vo.unionVo">
        INSERT INTO ProductDetail (seriesNum, productNum, colorNum, displayNum, storageNum, productPrice)
        VALUES (#{seriesNum}, #{productNum}, #{colorNum}, #{displayNum}, #{storageNum}, #{productPrice})
    </insert>
    
    <!-- 시리즈 가져오기 -->
	<select id="selectSeriesList" resultType="com.javaex.vo.unionVo">
		<![CDATA[ 
			select seriesNum,
				   seriesName
			from Series
		]]>
	</select>
    
    <!-- 상품명 가져오기 -->
	<select id="selectProductList" parameterType="int" resultType="com.javaex.vo.unionVo">
		<![CDATA[ 
			select seriesNum,
				   productNum,
				   productName
			from Product
			where seriesNum = #{seriesNum}
		]]>
	</select>
    
    <!-- 색상 가져오기 -->
	<select id="selectColorList" parameterType="int" resultType="com.javaex.vo.unionVo">
		<![CDATA[ 
			select colorNum,
				   productNum,
				   seriesNum,
				   colorName,
				   colorCode
			from Color
			where seriesNum = #{seriesNum}
		]]>
	</select>
	
    <!-- 디스플레이 가져오기 -->
	<select id="selectDisplayList" parameterType="int" resultType="com.javaex.vo.unionVo">
		<![CDATA[ 
			select displayNum,
				   productNum,
				   seriesNum,
				   displaySize
			from Display
			where seriesNum = #{seriesNum}
		]]>
	</select>
	
	<!-- 용량 가져오기 -->
	<select id="selectStroageList" parameterType="int" resultType="com.javaex.vo.unionVo">
		<![CDATA[ 
			select storageNum,
				   productNum,
				   seriesNum,
				   storageSize
			from Storage
			where seriesNum = #{seriesNum}
		]]>
	</select>
	
</mapper>